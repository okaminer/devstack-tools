#!/bin/bash
#
# script meant to test out functinality of ScaleIO Cinder Driver
#
# Supported Operations (as of Newton)
# - Create, delete, clone, attach, detach, manage, and unmanage volumes
# - Create, delete, manage, and unmanage volume snapshots
# - Create a volume from a snapshot
# - Copy an image to a volume
# - Copy a volume to an image
# - Extend a volume
# - Get volume statistics
# - Create, list, update, and delete consistency groups
# - Create, list, update, and delete consistency group snapshots

CMD_OPTS="--os-username admin --os-tenant-name admin"

# Volume Types
SIO_VOLUME_TYPE_THIN="ScaleIO-Thin"
SIO_VOLUME_TYPE_THICK="ScaleIO-Thick"


function show-volume-types {
  openstack volume type list
}

function create-volume-types {

  # thin
  openstack volume type create "${SIO_VOLUME_TYPE_THIN}" $CMD_OPTS
  openstack volume type set --property volume_backend_name=scaleio "${SIO_VOLUME_TYPE_THIN}" $CMD_OPTS
  openstack volume type set --property provisioning:type=thin "${SIO_VOLUME_TYPE_THIN}" $CMD_OPTS

  # thick
  openstack volume type create "${SIO_VOLUME_TYPE_THICK}" $CMD_OPTS
  openstack volume type set --property volume_backend_name=scaleio "${SIO_VOLUME_TYPE_THICK}" $CMD_OPTS
  openstack volume type set --property provisioning:type=thick "${SIO_VOLUME_TYPE_THICK}" $CMD_OPTS

}

function delete-volume-types {

  # thin
  openstack volume type delete "${SIO_VOLUME_TYPE_THIN}" $CMD_OPTS
  # thick
  openstack volume type delete "${SIO_VOLUME_TYPE_THICK}" $CMD_OPTS

}

# create some volumes
# NOTE: SCaleIO created volumes in size multiples of 8GB, asking for 1GB gets you 8GB
#
function create-volumes {
  # thin
  openstack volume create --type "${SIO_VOLUME_TYPE_THIN}" --size 1 thin-volume

  # thick
  openstack volume create --type "${SIO_VOLUME_TYPE_THICK}" --size 1 thick-volume
}

function delete-volumes {
  openstack volume delete volume [volume]
}



#
# mainline
#

create-volume-types
show-volume-types
create-volumes
delete-volume-types
