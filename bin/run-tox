#!/bin/bash
#
# This script simply runs tox, assuming a few things in the environment
#   CINDER_REPO   (repo to pull cinder from)
#   CINDER_BRANCH (branch of cinder to pull)

if [ -z "${CINDER_REPO}" -o -z "${CINDER_BRANCH}" ]; then
   echo "Either CINDER_REPO or CINDER_BRANCH is not set in the environment"
   exit
fi

# set the directory where the code is
DIRECTORY="/git/cinder"
if [ -d "/opt/stack/cinder" ]; then
  DIRECTORY="/opt/stack/cinder"
fi

# pull the repo, if we haven't already
if [ ! -d "${DIRECTORY}" ]; then
   git clone "${CINDER_REPO}" -b "${CINDER_BRANCH}" "${DIRECTORY}"
fi

# cd to the directory
cd "${DIRECTORY}"

# set the UPPER_CONSTRAINTS_FILE to point to an http (instead of https) URL
export UPPER_CONSTRAINTS_FILE=http://git.openstack.org/cgit/openstack/requirements/plain/upper-constraints.txt

# run tox
tox "$@" | tee /git/tox-output.txt
